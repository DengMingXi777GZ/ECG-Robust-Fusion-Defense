# Layer 2 é˜²å¾¡å±‚ (Defense Layer) - æœ€ç»ˆå®ŒæˆæŠ¥å‘Š

**æŠ¥å‘Šæ—¥æœŸ**: 2026-02-08  
**æ‰§è¡Œè€…**: Kimi Code CLI  
**é¡¹ç›®**: ECG å¯¹æŠ—é˜²å¾¡ç³»ç»Ÿ (MIT-BIH æ•°æ®é›†)  
**çŠ¶æ€**: âœ… **å…¨éƒ¨å®Œæˆ**

---

## ä¸€ã€æ‰§è¡Œæ‘˜è¦

Layer 2 é˜²å¾¡å±‚æ‰€æœ‰ä»»åŠ¡å·²æˆåŠŸå®Œæˆã€‚è®­ç»ƒäº† 3 ä¸ªé˜²å¾¡æ¨¡å‹ï¼ˆStandard ATã€NSRã€AT+NSRï¼‰ï¼Œå¹¶è¿›è¡Œäº†å…¨é¢å¯¹æ¯”è¯„ä¼°ã€‚æ‰€æœ‰æ¨¡å‹å‡è¶…é¢å®Œæˆé¢„æœŸç›®æ ‡ï¼Œå…¶ä¸­ **Standard AT** å’Œ **AT+NSR** è¾¾åˆ°äº† **0.94** çš„ ACC_robustï¼Œè¿œè¶…ç›®æ ‡å€¼ 0.78ã€‚

### å…³é”®æˆæœ
- âœ… Standard AT: ACC_robust = 0.94 (ç›®æ ‡ â‰¥0.70)
- âœ… NSR (Î²=0.4): ACC_robust = 0.89 (ç›®æ ‡ â‰¥0.75)
- âœ… AT+NSR: ACC_robust = 0.94 (ç›®æ ‡ â‰¥0.78)
- âœ… å…¨é¢å¯¹æ¯”è¯„ä¼°å®Œæˆ
- âœ… ç»“æœå·²ä¿å­˜è‡³ CSV å’Œ JSON

---

## äºŒã€ä»»åŠ¡å®Œæˆæ¸…å•

| ä»»åŠ¡ç¼–å· | ä»»åŠ¡åç§° | è¾“å‡ºæ–‡ä»¶ | çŠ¶æ€ |
|---------|---------|----------|------|
| Task 2.1 | å¯¹æŠ—è®­ç»ƒæ•°æ®é›†ç”Ÿæˆå™¨ | `defense/adv_trainer.py` | âœ… |
| Task 2.2 | eps=0.05 å¯¹æŠ—æ ·æœ¬ç”Ÿæˆ | `data/adversarial/eps005/` | âœ… |
| Task 2.3 | æ ‡å‡†å¯¹æŠ—è®­ç»ƒ | `checkpoints/adv_standard_at.pth` | âœ… |
| Task 2.4 | NSR æŸå¤±è®¡ç®—å™¨ | `defense/nsr_loss.py` | âœ… |
| Task 2.5 | NSR è®­ç»ƒç®¡é“ | `checkpoints/nsr_beta0.4.pth` | âœ… |
| Task 2.6 | AT+NSR è”åˆè®­ç»ƒ | `checkpoints/at_nsr.pth` | âœ… |
| Task 2.7 | é²æ£’æ€§è¯„ä¼°æ¡†æ¶ | `evaluation/defense_eval.py` | âœ… |
| Task 2.8 | è¶…å‚æ•°è°ƒä¼˜ | `experiments/tune_beta.py` | âœ… |

---

## ä¸‰ã€æ¨¡å‹æ€§èƒ½è¯¦ç»†åˆ†æ

### 3.1 é²æ£’æ€§å¯¹æ¯”è¡¨

```
+=================+=========+========+==========+===========+=======+==============+
| Model           |   Clean |   FGSM |   PGD-20 |   PGD-100 |   SAP |   ACC_robust |
+=================+=========+========+==========+===========+=======+==============+
| Clean (Layer 1) |   93.43 |  76.91 |    15.01 |     10.29 | 84.79 |         0.66 |
+-----------------+---------+--------+----------+-----------+-------+--------------+
| Standard AT     |   96.04 |  92.96 |    92.08 |     92.01 | 93.85 |         0.94 |
+-----------------+---------+--------+----------+-----------+-------+--------------+
| NSR (Î²=0.4)     |   97.27 |  82.81 |    80.95 |     81.02 | 82.08 |         0.89 |
+-----------------+---------+--------+----------+-----------+-------+--------------+
| AT+NSR          |   95.28 |  92.52 |    91.53 |     91.50 | 93.40 |         0.94 |
+-----------------+---------+--------+----------+-----------+-------+--------------+
```

### 3.2 å„æ¨¡å‹è¯¦ç»†åˆ†æ

#### 3.2.1 Clean Model (Layer 1 åŸºçº¿)
- **Clean Accuracy**: 93.43% (åŸå§‹åŸºçº¿)
- **PGD-20 Robust Accuracy**: 15.01%
- **åˆ†æ**: åŸå§‹æ¨¡å‹åœ¨å¯¹æŠ—æ”»å‡»ä¸‹è¡¨ç°è„†å¼±ï¼ŒPGD-20 æ”»å‡»æˆåŠŸç‡é«˜è¾¾ 85%

#### 3.2.2 Standard AT (Madry's å¯¹æŠ—è®­ç»ƒ)
- **Clean Accuracy**: 96.04% â¬†ï¸ (æ¯”åŸºçº¿æå‡ 2.61%)
- **PGD-20 Robust Accuracy**: 92.08% â¬†ï¸ (æ¯”åŸºçº¿æå‡ 77.07%)
- **ACC_robust**: 0.94 (ç›®æ ‡ â‰¥0.70, **è¶…é¢ 34%**)
- **åˆ†æ**: 
  - å¯¹æŠ—è®­ç»ƒæ˜¾è‘—æå‡äº†é²æ£’æ€§
  - åœ¨æ‰€æœ‰æ”»å‡»ç±»å‹ä¸‹å‡ä¿æŒ 90%+ å‡†ç¡®ç‡
  - SAP æ”»å‡»ä¸‹è¡¨ç°æœ€ä½³ (93.85%)

#### 3.2.3 NSR (Î²=0.4, NSR æ­£åˆ™åŒ–)
- **Clean Accuracy**: 97.27% â¬†ï¸ (æ‰€æœ‰æ¨¡å‹ä¸­æœ€é«˜)
- **PGD-20 Robust Accuracy**: 80.95% â¬†ï¸ (æ¯”åŸºçº¿æå‡ 65.94%)
- **ACC_robust**: 0.89 (ç›®æ ‡ â‰¥0.75, **è¶…é¢ 19%**)
- **åˆ†æ**:
  - å¹²å‡€æ ·æœ¬å‡†ç¡®ç‡æœ€é«˜
  - åœ¨ FGSM å’Œ SAP æ”»å‡»ä¸‹è¡¨ç°è‰¯å¥½
  - ç›¸æ¯” Standard ATï¼ŒPGD æ”»å‡»ä¸‹çš„é²æ£’æ€§ç•¥ä½

#### 3.2.4 AT+NSR (è”åˆè®­ç»ƒ - æœ€ä½³æ¨¡å‹)
- **Clean Accuracy**: 95.28%
- **PGD-20 Robust Accuracy**: 91.53%
- **PGD-100 Robust Accuracy**: 91.50%
- **ACC_robust**: 0.94 (ç›®æ ‡ â‰¥0.78, **è¶…é¢ 20%**)
- **åˆ†æ**:
  - ç»¼åˆæ€§èƒ½æœ€ä¼˜ï¼Œä¸ Standard AT ç›¸å½“
  - åœ¨å¼ºæ”»å‡» (PGD-100) ä¸‹ä»ä¿æŒ 91.50% å‡†ç¡®ç‡
  - æˆåŠŸç»“åˆäº† AT å’Œ NSR çš„ä¼˜ç‚¹

---

## å››ã€å…³é”®å‘ç°

### 4.1 é˜²å¾¡æ•ˆæœæ’å
1. **Standard AT** = **AT+NSR** (ACC_robust = 0.94) ğŸ¥‡
2. **NSR** (ACC_robust = 0.89) ğŸ¥ˆ
3. **Clean** (ACC_robust = 0.66) âŒ

### 4.2 æ”»å‡»éš¾åº¦æ’å (å¯¹ AT+NSR æ¨¡å‹)
1. **SAP** (93.40%) - æœ€éš¾æ”»å‡»
2. **FGSM** (92.52%) 
3. **PGD-20** (91.53%)
4. **PGD-100** (91.50%) - æœ€æ˜“æ”»å‡»ä½†ä»ä¿æŒé«˜å‡†ç¡®ç‡

### 4.3 è¶…å‚æ•°é€‰æ‹©
- **Î² = 0.4** åœ¨ NSR è®­ç»ƒä¸­è¡¨ç°è‰¯å¥½
- **eps = 0.05** æ˜¯æœ‰æ•ˆçš„è®­ç»ƒæ‰°åŠ¨é¢„ç®—
- **10 warmup epochs** æœ‰åŠ©äºç¨³å®š NSR è®­ç»ƒ

---

## äº”ã€ç”Ÿæˆæ–‡ä»¶æ¸…å•

### 5.1 æ¨¡å‹æ–‡ä»¶ (`checkpoints/`)
| æ–‡ä»¶ | å¤§å° | è¯´æ˜ |
|------|------|------|
| `clean_model.pth` | 529.52 KB | Layer 1 åŸºçº¿æ¨¡å‹ |
| `adv_standard_at.pth` | 529.97 KB | æ ‡å‡†å¯¹æŠ—è®­ç»ƒæ¨¡å‹ |
| `nsr_beta0.4.pth` | 529.90 KB | NSR æ­£åˆ™åŒ–æ¨¡å‹ |
| `at_nsr.pth` | 525.36 KB | AT+NSR è”åˆè®­ç»ƒæ¨¡å‹ (æœ€ä½³) |

### 5.2 è®­ç»ƒå†å² (`checkpoints/`)
| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `adv_standard_at_history.json` | Standard AT è®­ç»ƒæ›²çº¿ |
| `nsr_beta0.4_history.json` | NSR è®­ç»ƒæ›²çº¿ |
| `at_nsr_history.json` | AT+NSR è®­ç»ƒæ›²çº¿ |

### 5.3 è¯„ä¼°ç»“æœ (`results/`)
| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `defense_evaluation.json` | è¯¦ç»†è¯„ä¼°ç»“æœ |
| `defense_comparison.csv` | å¯¹æ¯”è¡¨æ ¼ (CSV æ ¼å¼) |

---

## å…­ã€ä»£ç æ–‡ä»¶æ¸…å•

### 6.1 æ ¸å¿ƒé˜²å¾¡æ¨¡å— (`defense/`)
| æ–‡ä»¶ | è¡Œæ•° | åŠŸèƒ½ |
|------|------|------|
| `adv_trainer.py` | 239 | å¯¹æŠ—æ•°æ®é›†ç”Ÿæˆå™¨ |
| `nsr_loss.py` | 249 | NSR æŸå¤±å‡½æ•° |
| `train_standard_at.py` | 353 | æ ‡å‡†å¯¹æŠ—è®­ç»ƒ |
| `train_nsr.py` | 385 | NSR è®­ç»ƒç®¡é“ |
| `train_at_nsr.py` | 369 | è”åˆè®­ç»ƒ |

### 6.2 è¯„ä¼°ä¸å®éªŒ
| æ–‡ä»¶ | è¡Œæ•° | åŠŸèƒ½ |
|------|------|------|
| `evaluation/defense_eval.py` | 382 | é²æ£’æ€§è¯„ä¼°æ¡†æ¶ |
| `experiments/tune_beta.py` | 382 | è¶…å‚æ•°è°ƒä¼˜ |

**æ€»ä»£ç é‡**: 2,266+ è¡Œ Python ä»£ç 

---

## ä¸ƒã€ä½¿ç”¨æ–¹æ³•

### 7.1 è¯„ä¼°å•ä¸ªæ¨¡å‹
```bash
python evaluation/defense_eval.py \
    --model checkpoints/at_nsr.pth \
    --model-name "AT+NSR" \
    --eps 0.05
```

### 7.2 å¯¹æ¯”æ‰€æœ‰æ¨¡å‹
```bash
python evaluation/defense_eval.py --compare --eps 0.05
```

### 7.3 ä½¿ç”¨æ¨¡å‹è¿›è¡Œé¢„æµ‹
```python
import torch
from models.ecg_cnn import ECG_CNN

# åŠ è½½æœ€ä½³æ¨¡å‹
model = ECG_CNN(num_classes=5)
checkpoint = torch.load('checkpoints/at_nsr.pth', weights_only=False)
model.load_state_dict(checkpoint['model_state_dict'])
model.eval()

# é¢„æµ‹
with torch.no_grad():
    output = model(x)  # x: [batch, 1, 187]
    pred = output.argmax(dim=1)
```

---

## å…«ã€ä¸ Layer 3 çš„è¡”æ¥

Layer 3 å°†ä½¿ç”¨ Layer 2 çš„é²æ£’æ¨¡å‹ä½œä¸ºç‰¹å¾æå–å™¨ï¼š

```python
# Layer 3 ä½¿ç”¨ç¤ºä¾‹
from models.ecg_cnn import ECG_CNN
import torch.nn as nn

# åŠ è½½é¢„è®­ç»ƒçš„é²æ£’æ¨¡å‹
robust_model = ECG_CNN(num_classes=5)
checkpoint = torch.load('checkpoints/at_nsr.pth', weights_only=False)
robust_model.load_state_dict(checkpoint['model_state_dict'])

# ä½œä¸ºç‰¹å¾æå–å™¨ (å»æ‰æœ€åçš„ FC å±‚)
feature_extractor = nn.Sequential(*list(robust_model.children())[:-1])
features = feature_extractor(x)  # æå–æ·±åº¦ç‰¹å¾
```

**å…³é”®ç»§æ‰¿ç‚¹**:
- `checkpoints/at_nsr.pth` å°†ä½œä¸º Layer 3 çš„ `deep_branch` é¢„è®­ç»ƒæƒé‡
- `checkpoints/nsr_beta0.4.pth` å¯ä½œä¸ºå¤‡é€‰ç‰¹å¾æå–å™¨

---

## ä¹ã€ç»“è®º

Layer 2 é˜²å¾¡å±‚å·²æˆåŠŸå®Œæˆæ‰€æœ‰æ—¢å®šä»»åŠ¡ï¼š

1. âœ… **å®ç°äº† 3 ç§é˜²å¾¡æ–¹æ³•**: Standard ATã€NSRã€AT+NSR
2. âœ… **è¶…é¢å®Œæˆç›®æ ‡**: æœ€ä½³æ¨¡å‹ ACC_robust = 0.94 (ç›®æ ‡ 0.78)
3. âœ… **å…¨é¢å¯¹æ¯”è¯„ä¼°**: ç”Ÿæˆäº†è¯¦ç»†çš„é²æ£’æ€§å¯¹æ¯”è¡¨
4. âœ… **ä»£ç å®Œæ•´æ€§**: 2,266+ è¡Œå¯å¤ç”¨ä»£ç 
5. âœ… **ä¸ Layer 3 è¡”æ¥**: å‡†å¤‡å¥½ç‰¹å¾æå–å™¨æƒé‡

### æœ€ä½³æ¨¡å‹æ¨è
- **AT+NSR** (`checkpoints/at_nsr.pth`): ç»¼åˆæ€§èƒ½æœ€ä½³
- **Standard AT** (`checkpoints/adv_standard_at.pth`): è®­ç»ƒé€Ÿåº¦æ›´å¿«ï¼Œæ•ˆæœç›¸å½“

### ä¸‹ä¸€æ­¥å»ºè®®
1. è¿›å…¥ Layer 3: ä½¿ç”¨é²æ£’æ¨¡å‹æ„å»ºåŒåˆ†æ”¯æ£€æµ‹å™¨
2. å¯é€‰: ç”Ÿæˆ Accuracy vs Epsilon æ›²çº¿è¿›è¡Œå¯è§†åŒ–
3. å¯é€‰: åœ¨å…¶ä»–æ•°æ®é›†ä¸ŠéªŒè¯æ¨¡å‹æ³›åŒ–èƒ½åŠ›

---

**æŠ¥å‘Šå®Œæˆæ—¶é—´**: 2026-02-08  
**æ‰§è¡ŒçŠ¶æ€**: âœ… **Layer 2 å…¨éƒ¨å®Œæˆï¼Œå¯è¿›å…¥ Layer 3**
